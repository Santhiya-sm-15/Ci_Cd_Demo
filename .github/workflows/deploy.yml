name: Deploy to cloud run

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
    inputs:
      environments:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
env:
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: my-repo
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Authenticate to google cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Configure docker for Google Artifact Registry
        run: |
          gcloud auth configure-docker "${ env.GCP_REGION }-docker.pkg.dev" --quiet
      - name: Set Image tag
        id: image-tag
        run: |
          echo "tags=$env.GCP_REGION-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${ ARTIFACT_REGISTRY }/demo:latest" >> $GITHUB_OUTPUT
          echo "tags-sha=$env.GCP_REGION-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${ ARTIFACT_REGISTRY }/demo:${{ github.sha }}" >> $GITHUB_OUTPUT
      - name: Build Docker Image
        run: |
          docker build -t ${{  steps.image-tag.outputs.tag }} -t ${{ steps.image-tag.outpts.tag-sha }} --file Dockerfile .
      - name: Push Docker Image
        run: |
          docker push ${{ steps.image-tag.outputs.tag }} 
          docker push ${{ steps.image-tag.outputs.tag-sha }}

      - name: Deploy to cloud run
        run: |
          gcloud run deploy demo --image ${{ steps.image-tag.outputs.tag }} -- region ${ env.GCP_REGION } --platform managed --allow-unauthenticated --port 8080 \
          --cpu 1 --memory 512Mi --max-instances 5 --timeout 300s --quiet
      - name: Get URL
        id: get-url
        run: |
          URL=$(gcloud run services describe demo --region $env.GCP_REGION --platform managed --format 'value(status.url)')
          echo "URL=$URL" >> $GITHUB_OUTPUT
      - name: Verify Deployment 
        run: |
          curl -f ${{ steps.get-url.outputs.URL }} || exit 1